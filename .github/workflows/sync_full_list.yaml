name: Golang Binary Sync

on:
  workflow_dispatch:
    inputs:
      binvern:
        description: '指定Golang版本序号(只能{ =0 | 1 }二选一,默认为0)'
        required: false
        type: string
  schedule:
   - cron: '10 2 * * *'  # 每天凌晨2点10分自动执行(使用最新版本)

permissions:
  contents: write

jobs:
  sync_binaries:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 下载各平台二进制包
      - name: 下载指定版本Golang的二进制包
        id: get_files
        run: |
          # 设置错误退出
          set -e

          get_files_and_export_envs() {
            local vnidx=${{ github.event.inputs.binvern }}
            # 验证输入参数
            if [[ "$vnidx" != "" && "$vnidx" != "0" && "$vnidx" != "1" ]]; then
              echo "错误: 版本序号必须是0或1"
              exit 1
            fi

            [ X1 != X${vnidx} ] && vnidx=0
            local pat_fn=".[${vnidx}].files[].filename"
            local pat_vn=".[${vnidx}].version"
            local tmp_json="tmp.json"

            # 定义下载源(优先使用国内源)
            local sources=(
              "https://golang.google.cn/dl/"
              "https://go.dev/dl/"
            )

            local baseurl
            local download_success=false

            # 尝试从多个源下载
            for source in "${sources[@]}"; do
              echo "尝试从源下载: $source"
              if curl -4fsLo "${tmp_json}" "${source}?mode=json"; then
                baseurl="${source}"
                download_success=true
                echo "成功从源获取版本信息: $source"
                break
              else
                echo "从源获取版本信息失败: $source"
              fi
            done

            if [[ "$download_success" == false ]]; then
              echo "错误: 无法从任何源获取版本信息"
              exit 1
            fi

            # 验证JSON文件是否有效
            if ! jq -e . < "${tmp_json}" > /dev/null 2>&1; then
              echo "错误: 获取的版本信息不是有效的JSON"
              exit 1
            fi

            # 创建dist目录
            mkdir -p dist

            # 并行下载文件
            local files=()
            while IFS= read -r filename; do
              files+=("$filename")
            done < <(jq -r "${pat_fn}" < "${tmp_json}")

            if [[ ${#files[@]} -eq 0 ]]; then
              echo "错误: 未找到任何文件"
              exit 1
            fi

            echo "找到 ${#files[@]} 个文件,开始并行下载..."

            local download_errors=0
            for filename in "${files[@]}"; do
              local local_path="dist/${filename}"
              local remote_url="${baseurl}/${filename}"

              (echo "下载: $remote_url"; curl -fLo "$local_path" "$remote_url" && echo "成功: $filename" || { echo "失败: $filename"; download_errors=$((download_errors+1)); }) &
            done

            # 等待所有下载完成
            wait

            if [[ $download_errors -gt 0 ]]; then
              echo "错误: 有 $download_errors 个文件下载失败"
              exit 1
            fi

            # 获取版本号
            local vnstr=$(jq -r "${pat_vn}" < "${tmp_json}")
            if [[ -z "$vnstr" ]]; then
              echo "错误: 无法获取版本号"
              exit 1
            fi

            echo "使用的版本号: ${vnstr}"
            rm -f "${tmp_json}"

            # 追加到环境变量中
            echo "VNSTR=v${vnstr#go}" >> "$GITHUB_ENV"
            echo "BSURL=${baseurl}" >> "$GITHUB_ENV"
            echo "DOWNLOAD_COUNT=${#files[@]}" >> "$GITHUB_ENV"
          }

          # 执行下载函数
          get_files_and_export_envs

      - name: 验证下载结果
        id: verify_download
        run: |
          if [[ ! -d "dist" ]]; then
            echo "错误: dist目录不存在"
            exit 1
          fi

          local file_count=$(ls -la dist/ | grep -v "^total" | grep -v "^\." | wc -l)
          if [[ $file_count -eq 0 ]]; then
            echo "错误: dist目录为空,没有下载任何文件"
            exit 1
          fi

          echo "成功下载 ${file_count} 个文件"
          echo "文件列表:"
          ls -la dist/

      - name: 发布到Releases
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          tag_name: "${{ env.VNSTR }}"  # 用版本号作为tag(如v0.12.0)
          name: "Golang ${{ env.VNSTR }} Binaries"
          body: |
            自动同步自 Golang 官网的二进制程序
            - 版本: ${{ env.VNSTR }}
            - 官网下载地址: ${{env.BSURL}}
            - 下载文件数量: ${{ env.DOWNLOAD_COUNT }}
            - 同步时间: ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
          overwrite: true  # 覆盖已有版本,确保始终使用最新版本

      - name: 清理临时文件
        if: always()
        run: |
          rm -rf dist/ tmp.json
          echo "清理完成"
